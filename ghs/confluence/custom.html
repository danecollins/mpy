/* this is installed in the Confluence Admin - Custom HTML (last entry) in the At the end of HEAD block */
/* DO NOT INCLUDE THESE COMMENTS */

<script type="text/javascript">
if (!String.prototype.startsWith) {
  Object.defineProperty(String.prototype, 'startsWith', {
    enumerable: false,
    configurable: false,
    writable: false,
    value: function (searchString, position) {
      position = position || 0;
      return this.lastIndexOf(searchString, position) === position;
    }
  });
}

var myWindow;
function execmd(cmd) {
  	/* cmd can contain multiple commands. If so, parse them and execute them separately */

        console.log("In execmd");
   	var cmds = cmd.split("|");

	console.log("EXECMD: " + cmds.length + " command received");

  	var baseURL = "http://localhost:8008/";

  	for (var i in cmds) {
        
        /* alert(cmds[i]); */
        console.log("  " + cmds[i]);
        
        /* handle various syntax shortcuts that are allowed in wiki macro */
        if (cmds[i].startsWith("OpenSchematic")) {
    		  var parts = cmds[i].split(" ");
    		  cmds[i] = parts[0] + "?name=" + parts[1]
    	}
        if (cmds[i].startsWith("OpenEM")) {
    		  var parts = cmds[i].split(" ");
    		  cmds[i] = parts[0] + "?name=" + parts[1]
    	}
        if (cmds[i].startsWith("OpenSystemDiagram")) {
          var parts = cmds[i].split(" ");
          cmds[i] = parts[0] + "?name=" + parts[1]
        }
    	if (cmds[i].startsWith("LoadProject")) {
        	var parts = cmds[i].split(" ");
        	cmds[i] = parts[0] + "?name=" + parts[1]
    	}
        if (cmds[i].startsWith("LoadSchematic")) {
            var parts = cmds[i].split(" ");
            cmds[i] = parts[0] + "?name=" + parts[1]
        }
        if (cmds[i].startsWith("LoadSystemDiagram")) {
            var parts = cmds[i].split(" ");
            cmds[i] = parts[0] + "?name=" + parts[1]
        }
        if (cmds[i].startsWith("OpenUserFolder")) {
            var parts = cmds[i].split(" ");
            cmds[i] = parts[0] + "?name=" + parts[1]
        }
        if (cmds[i].startsWith("OpenProject")) {
            var parts = cmds[i].split(" ");
            cmds[i] = parts[0] + "?name=" + parts[1]
        }
        if (cmds[i].startsWith("OpenGraph")) {
            var parts = cmds[i].split(" ");
            cmds[i] = parts[0] + "?name=" + parts[1]
        }
    	if (cmds[i].startsWith("RunScript")) {
        	var parts = cmds[i].split(" ");
        	cmds[i] = parts[0] + "?name=" + parts[1]
    	}

	var path =  baseURL + cmds[i];
        console.log("   Http Get Request: " + path);
        /* myWindow = window.open(path, "LogWindow", "width=300, height=50"); */
	var request = new XMLHttpRequest();
	request.open('GET', path, false);
	try {
		/* send always throws an error but I don't know why */
		request.send(null);
	}
	catch (err) {
		console.log("      exeception: " + path);
	}

  }
}
</script>